<%def name="remove(who)">
tp @e[${who}] @e[tag=death,limit=1]
</%def>

<%def name="increment(count)">\
execute unless score ${var} funcs matches 0.. run function ${var}_init
scoreboard players add ${var} funcs 1
execute unless score ${var} funcs matches 0..${count - 1} run scoreboard players set ${var} funcs 0
</%def>

<%def name="when(i, as_prefix=False)">execute if score ${var} funcs matches ${i}${"" if as_prefix else " run"}</%def>

<%def name="loop(collection)">
${increment(len(collection))}\
% for thing in collection:
${caller.body(when, loop.index, thing)}
% endfor
</%def>

<%def name="bounce(collection)">
<%
    backwards = collection[1:-1]
    backwards.reverse()
    merged = collection + backwards 
%>\
${increment(len(merged))}\
% for thing in merged:
${caller.body(when, loop.index, thing)}\
% endfor
</%def>

<%def name="on_stand(where, mob, nbt='')">
summon armor_stand ${where} {Small:True,Passengers:[{id:${to_id(mob)},CustomName:${text(mob)},${"%s," % nbt if nbt else ""}NoAI:True,Silent:True}]}
</%def>

<%!
    global x, z, x_delta, z_delta, adult_x, adult_z, kid_x, kid_z, rotation
    x = z = x_delta = z_delta = adult_x = adult_z = kid_x = kid_z = rotation = 0
%>

<%def name="mobs_init(x_init=None, z_init=None, x_delta_init=None, z_delta_init=None, kid_x_init=None, kid_z_init=None, adult_x_init=None, adult_z_init=None, rotation_init=None)">
<%
    global x, z, x_delta, z_delta, adult_x, adult_z, kid_x, kid_z, rotation
    x = z = x_delta = z_delta = adult_x = adult_z = kid_x = kid_z = rotation = 0
    x = x_init if x_init else x
    z = z_init if z_init else z
    x_delta = x_delta_init if x_delta_init else x_delta
    z_delta = z_delta_init if z_delta_init else z_delta
    adult_x = adult_x_init if adult_x_init else adult_x
    adult_z = adult_z_init if adult_z_init else adult_z
    kid_x = kid_x_init if kid_x_init else kid_x
    kid_z = kid_z_init if kid_z_init else kid_z
    rotation = rotation_init if rotation_init else rotation
%>
</%def>

<%def name="kid(thing, x, y_add, z, rotation, nbt='', tags=())">\
<% nbt = ",%s" % nbt if nbt else "" %>\
summon ${thing.full_id()} ~${x} ~${2 + y_add} ~${z} {IsBaby:True,Age:-2147483648,Tags:[${",".join(tags + ("kid",))}]${nbt},NoAI:True,Silent:True,Rotation:[${rotation}f,0f]}
</%def>

<%def name="adult(thing, x, y_add, z, rotation, nbt='', tags=())">\
<% nbt = ",%s" % nbt if nbt else "" %>\
summon ${thing.full_id()} ~${x} ~${2 + y_add} ~${z} {CustomName:${text(thing.name)},Tags:[${",".join(tags)}]${nbt},NoAI:True,Silent:True,Rotation:[${rotation}f,0f]}
</%def>

<%def name="mobs(name, id=None, nbt='', tags=(), name_kid=False, do_kid=False, do_adult=False, y_add=0)">\
<%
    global x, z, x_delta, z_delta, adult_x, adult_z, kid_x, kid_z, rotation
    if not do_kid and not do_adult:
	do_kid = do_adult = True
    thing = Thing(name, id)
    if name_kid:
	nbt = ',' + nbt if nbbt else ''
	nbt = "CustomName:%s" % text(name) + nbt
    if do_kid:
	kid(thing, x + kid_x, y_add, z + kid_z, rotation, nbt, tags)
    if do_adult:
	adult(thing, x + adult_x, y_add, z + adult_z, rotation, nbt, tags)
    x += x_delta
    z += z_delta
%>\
</%def>
